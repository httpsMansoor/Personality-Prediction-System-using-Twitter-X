<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your MBTI Personality Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #1acc8d;
      --secondary-color: #17a2b8;
      --dark-color: #2c4964;
      --light-color: #f8f9fa;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      color: var(--dark-color);
    }

    .header {
      background: white;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
      padding: 1rem 0;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      border-bottom: 3px solid var(--primary-color);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .logo h1 {
      margin: 0;
      font-size: 24px;
      padding: 0;
      line-height: 1;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .logo a {
      color: var(--dark-color);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo i {
      color: var(--primary-color);
      font-size: 28px;
    }

    .nav-menu {
      display: flex;
      justify-content: flex-end;
    }

    .nav-menu ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
    }

    .nav-menu li {
      margin-left: 2rem;
    }

    .nav-menu a {
      color: var(--dark-color);
      text-decoration: none;
      font-weight: 500;
      font-size: 15px;
      padding: 8px 16px;
      border-radius: 50px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-menu a i {
      color: var(--primary-color);
      font-size: 16px;
    }

    .nav-menu a:hover {
      color: var(--primary-color);
      background: rgba(26, 204, 141, 0.1);
    }

    main {
      margin-top: 100px;
      padding: 2rem 0;
    }

    .personality-card {
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      background: white;
      margin-top: 2rem;
    }

    .personality-card:hover {
      transform: translateY(-5px);
    }

    .personality-header {
      background: linear-gradient(45deg, #1acc8d, #17a2b8);
      color: white;
      padding: 2rem;
      border-radius: 15px 15px 0 0;
      text-align: center;
    }

    .personality-content {
      padding: 2rem;
    }

    .trait-box {
      padding: 20px;
      border-radius: 10px;
      margin: 10px 0;
      background: #f8f9fa;
      transition: all 0.3s ease;
      border: 1px solid #e9ecef;
    }

    .trait-box:hover {
      background: #e9ecef;
      transform: scale(1.02);
    }

    .trait-label {
      font-weight: 600;
      color: var(--dark-color);
      display: block;
      margin-bottom: 0.5rem;
    }

    .trait-description {
      color: #444444;
      margin: 0;
    }

    .tweet-box {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .tweet-box:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .btn {
      display: inline-block;
      padding: 0.8rem 1.5rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-outline-primary {
      background: transparent;
      border: 2px solid var(--primary-color);
      color: var(--primary-color);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .text-center {
      text-align: center;
    }

    .mt-5 {
      margin-top: 3rem;
    }

    .ml-2 {
      margin-left: 0.5rem;
    }

    .d-inline-block {
      display: inline-block;
    }

    .toggle-tweets[aria-expanded="true"] .fa-chevron-down {
      transform: rotate(180deg);
    }

    .fa-chevron-down {
      transition: transform 0.3s ease;
    }

    #moreTweets {
      transition: all 0.3s ease;
    }

    .collapse.show {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .chart-container {
      position: relative;
      margin: 20px 0;
      height: 400px;
      width: 100%;
    }

    .charts-section {
      margin-top: 2rem;
      padding: 2rem;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
    }

    .chart-title {
      text-align: center;
      margin-bottom: 1.5rem;
      color: var(--dark-color);
      font-weight: 600;
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header class="header">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="logo">
        <h1>
          <a href="/">
            <i class="fas fa-brain"></i>
            <span>Personality Prediction System</span>
          </a>
        </h1>
      </div>
      <nav class="nav-menu">
        <ul>
          <li><a href="/"><i class="fas fa-home"></i>Home</a></li>
          <li><a href="/logout"><i class="fas fa-sign-out-alt"></i>Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <div class="personality-card">
            <div class="personality-header">
              <h2>MBTI Personality Analysis for @{{ username }}</h2>
              <h1 style="font-size: 3.5rem; margin: 1rem 0;">{{ personality }}</h1>
              {% if is_cached %}
              <p style="opacity: 0.8">Prediction from: {{ prediction_date }}</p>
              {% endif %}
            </div>
            
            <div class="personality-content">
              <div class="traits-breakdown">
                <h3 class="mb-4">Your Personality Traits Breakdown</h3>
                
                <div class="trait-box">
                  <span class="trait-label">{{ personality[0] }} - {{ "Introversion" if personality[0] == "I" else "Extraversion" }}</span>
                  <p class="trait-description">
                    {% if personality[0] == "I" %}
                    You tend to focus on your inner world and get energy from your ideas and memories.
                    {% else %}
                    You focus on the outer world and get energy from interacting with people and doing things.
                    {% endif %}
                  </p>
                </div>

                <div class="trait-box">
                  <span class="trait-label">{{ personality[1] }} - {{ "Intuition" if personality[1] == "N" else "Sensing" }}</span>
                  <p class="trait-description">
                    {% if personality[1] == "N" %}
                    You prefer to focus on abstract concepts and possibilities for the future.
                    {% else %}
                    You prefer to focus on concrete facts and present realities.
                    {% endif %}
                  </p>
                </div>

                <div class="trait-box">
                  <span class="trait-label">{{ personality[2] }} - {{ "Thinking" if personality[2] == "T" else "Feeling" }}</span>
                  <p class="trait-description">
                    {% if personality[2] == "T" %}
                    You tend to make decisions based on logic and objective analysis.
                    {% else %}
                    You tend to make decisions based on personal values and how actions affect others.
                    {% endif %}
                  </p>
                </div>

                <div class="trait-box">
                  <span class="trait-label">{{ personality[3] }} - {{ "Judging" if personality[3] == "J" else "Perceiving" }}</span>
                  <p class="trait-description">
                    {% if personality[3] == "J" %}
                    You prefer a planned and organized approach to life.
                    {% else %}
                    You prefer a flexible and spontaneous approach to life.
                    {% endif %}
                  </p>
                </div>
              </div>

              <!-- Add Charts Section after traits breakdown -->
              <div class="charts-section">
                <h3 class="chart-title">Personality Analysis Visualization</h3>
                <div class="row">
                  <div class="col-md-6">
                    <div class="chart-container">
                      <canvas id="personalityRadar"></canvas>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="chart-container">
                      <canvas id="personalityBar"></canvas>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Analyzed Tweets Section -->
              <div class="analyzed-tweets mt-5">
                <h3 class="mb-4">Analyzed Tweets</h3>
                <div class="tweets-container">
                  <!-- All tweets container -->
                  <div id="allTweets">
                    <!-- First 5 tweets shown directly -->
                    {% for tweet in tweets[:5] %}
                    <div class="tweet-box">
                      <p class="mb-0">{{ tweet }}</p>
                    </div>
                    {% endfor %}

                    <!-- Remaining tweets in collapsible section -->
                    {% if tweets|length > 5 %}
                    <div class="collapse" id="moreTweets">
                      {% for tweet in tweets[5:] %}
                      <div class="tweet-box">
                        <p class="mb-0">{{ tweet }}</p>
                      </div>
                      {% endfor %}
                    </div>

                    <!-- Show More/Less button at the bottom -->
                    <div class="text-center mt-4">
                      <button class="btn btn-outline-primary toggle-tweets" type="button" data-bs-toggle="collapse" 
                              data-bs-target="#moreTweets" aria-expanded="false" aria-controls="moreTweets">
                        <i class="fas fa-chevron-down mr-2"></i>
                        Show More Tweets ({{ tweets|length - 5 }} more)
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="text-center mt-5">
                <a href="/" class="btn btn-primary">Analyze Another Profile</a>
                {% if is_cached %}
                <form id="refreshForm" action="/predict" method="POST" class="d-inline-block ml-2">
                  <input type="hidden" name="username" value="{{ username }}">
                  <input type="hidden" name="force_refresh" value="true">
                  <button type="submit" class="btn btn-outline-primary">Refresh Prediction</button>
                </form>
                {% endif %}
              </div>

              <!-- Progress Bar -->
              <div id="progressSection" style="display: none;" class="mt-4">
                <div class="progress-status text-center mb-2">
                  <span id="statusMessage">Initializing...</span>
                </div>
                <div class="progress">
                  <div id="predictionProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                       role="progressbar" style="width: 0%"></div>
                </div>
                <div class="progress-steps mt-2">
                  <div class="step active" id="step1">
                    <i class="fas fa-search"></i> Fetching Tweets
                  </div>
                  <div class="step" id="step2">
                    <i class="fas fa-database"></i> Processing Data
                  </div>
                  <div class="step" id="step3">
                    <i class="fas fa-brain"></i> Making Prediction
                  </div>
                  <div class="step" id="step4">
                    <i class="fas fa-check"></i> Complete
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle tweets functionality
      const toggleButton = document.querySelector('.toggle-tweets');
      if (toggleButton) {
        const totalTweets = parseInt('{{ tweets|length }}');
        toggleButton.addEventListener('click', function() {
          const isExpanded = this.getAttribute('aria-expanded') === 'true';
          
          if (!isExpanded) {
            this.innerHTML = '<i class="fas fa-chevron-down mr-2"></i>Show Less Tweets';
          } else {
            this.innerHTML = '<i class="fas fa-chevron-down mr-2"></i>Show More Tweets (' + (totalTweets - 5) + ' more)';
          }
        });
      }

      // Refresh prediction functionality
      const refreshForm = document.getElementById('refreshForm');
      if (refreshForm) {
        refreshForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Show progress section
          document.getElementById('progressSection').style.display = 'block';
          
          // Reset progress
          document.getElementById('predictionProgress').style.width = '0%';
          document.getElementById('statusMessage').textContent = 'Initializing...';
          
          // Reset steps
          document.querySelectorAll('.step').forEach(step => {
            step.classList.remove('active', 'completed');
          });
          document.getElementById('step1').classList.add('active');
          
          // Submit form
          fetch('/predict', {
            method: 'POST',
            body: new FormData(this)
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              document.getElementById('statusMessage').textContent = data.error;
              document.getElementById('predictionProgress').classList.add('bg-danger');
            } else {
              // Update progress based on response
              document.getElementById('predictionProgress').style.width = `${data.progress}%`;
              document.getElementById('statusMessage').textContent = data.status;
              
              // Update steps
              for (let i = 1; i <= data.step; i++) {
                document.getElementById(`step${i}`).classList.add('completed');
                if (i < data.step) {
                  document.getElementById(`step${i + 1}`).classList.add('active');
                }
              }
              
              // Redirect after a short delay to show completion
              setTimeout(() => {
                window.location.href = data.redirect_url;
              }, 500);
            }
          })
          .catch(error => {
            document.getElementById('statusMessage').textContent = 'An error occurred. Please try again.';
            document.getElementById('predictionProgress').classList.add('bg-danger');
          });
        });
      }

      // Personality Charts
      const personality = '{{ personality }}';
      const personalityTraits = {
        'I': 'Introversion',
        'E': 'Extraversion',
        'N': 'Intuition',
        'S': 'Sensing',
        'T': 'Thinking',
        'F': 'Feeling',
        'J': 'Judging',
        'P': 'Perceiving'
      };

      // Radar Chart for Personality Traits
      const radarCtx = document.getElementById('personalityRadar').getContext('2d');
      const radarChart = new Chart(radarCtx, {
        type: 'radar',
        data: {
          labels: ['Introversion/Extraversion', 'Intuition/Sensing', 'Thinking/Feeling', 'Judging/Perceiving'],
          datasets: [{
            label: 'Your Personality Profile',
            data: [
              personality[0] === 'I' ? 80 : 20,  // I/E
              personality[1] === 'N' ? 80 : 20,  // N/S
              personality[2] === 'T' ? 80 : 20,  // T/F
              personality[3] === 'J' ? 80 : 20   // J/P
            ],
            backgroundColor: 'rgba(26, 204, 141, 0.2)',
            borderColor: 'rgba(26, 204, 141, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(26, 204, 141, 1)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgba(26, 204, 141, 1)'
          }]
        },
        options: {
          scales: {
            r: {
              angleLines: {
                display: true
              },
              suggestedMin: 0,
              suggestedMax: 100
            }
          },
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });

      // Bar Chart for MBTI Types
      const barCtx = document.getElementById('personalityBar').getContext('2d');
      const mbtiTypes = [
        'INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP',
        'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'
      ];
      
      // Generate confidence scores for all types
      const confidenceScores = mbtiTypes.map(type => {
        if (type === personality) return 100;
        // Generate lower scores for similar types
        let score = 30;
        // Add some variation based on how many letters match
        for (let i = 0; i < 4; i++) {
          if (type[i] === personality[i]) {
            score += 10;
          }
        }
        return score;
      });

      const barChart = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: mbtiTypes,
          datasets: [{
            label: 'Confidence Score',
            data: confidenceScores,
            backgroundColor: mbtiTypes.map(type => 
              type === personality ? 'rgba(26, 204, 141, 0.8)' : 'rgba(23, 162, 184, 0.3)'
            ),
            borderColor: mbtiTypes.map(type => 
              type === personality ? 'rgba(26, 204, 141, 1)' : 'rgba(23, 162, 184, 0.5)'
            ),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y', // This makes the chart horizontal
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              title: {
                display: true,
                text: 'Confidence Score (%)',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              }
            },
            y: {
              ticks: {
                font: {
                  size: 12,
                  weight: 'bold'
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const type = mbtiTypes[context.dataIndex];
                  const score = context.raw.toFixed(1);
                  const isPredicted = type === personality;
                  return [
                    `Type: ${type}`,
                    `Confidence: ${score}%`,
                    isPredicted ? '(Predicted Type)' : ''
                  ];
                }
              }
            },
            title: {
              display: true,
              text: 'MBTI Type Confidence Scores',
              font: {
                size: 16,
                weight: 'bold'
              },
              padding: {
                top: 10,
                bottom: 20
              }
            }
          }
        }
      });
    });
  </script>
</body>
</html>
